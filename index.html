<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create App Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1" integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-primary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-header: #0f172a;
            --bg-header-accent: #1e293b;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-dim: #94a3b8;
            --text-on-dark: #f8fafc;
            --accent-blue: #3b82f6;
            --accent-blue-light: #dbeafe;
            --accent-green: #22c55e;
            --accent-green-light: #dcfce7;
            --accent-amber: #f59e0b;
            --accent-amber-light: #fef3c7;
            --accent-red: #ef4444;
            --accent-red-light: #fee2e2;
            --accent-purple: #8b5cf6;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04);
            --radius: 10px;
            --radius-sm: 6px;
            --gap: 16px;
            --transition: 0.2s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-header);
            color: var(--text-on-dark);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        .header-subtitle {
            font-size: 12px;
            color: var(--text-dim);
            font-weight: 400;
        }
        .live-dot {
            width: 8px; height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
            50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(34,197,94,0); }
        }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .env-toggle {
            background: var(--bg-header-accent);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-on-dark);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
        }
        .last-updated { font-size: 11px; color: var(--text-dim); }

        /* Container */
        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 20px 24px;
        }

        /* KPI Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--gap);
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 18px 20px;
            box-shadow: var(--shadow-sm);
            border-left: 3px solid transparent;
            transition: transform var(--transition), box-shadow var(--transition);
        }
        .stat-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .stat-card.running { border-left-color: var(--accent-amber); }
        .stat-card.queued { border-left-color: var(--accent-blue); }
        .stat-card.completed { border-left-color: var(--accent-green); }
        .stat-card.failed { border-left-color: var(--accent-red); }
        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-dim);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
        }
        .stat-card.running .stat-value { color: var(--accent-amber); }
        .stat-card.queued .stat-value { color: var(--accent-blue); }
        .stat-card.completed .stat-value { color: var(--accent-green); }
        .stat-card.failed .stat-value { color: var(--accent-red); }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .action-bar-left { display: flex; align-items: center; gap: 12px; }
        .btn-primary {
            background: var(--accent-blue);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition), transform var(--transition);
        }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }
        .btn-secondary:hover { border-color: var(--border-medium); background: #f8fafc; }
        .concurrency-control {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; color: var(--text-secondary);
        }
        .concurrency-control input {
            width: 48px;
            padding: 6px 8px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 12px;
            text-align: center;
        }

        /* Search + Filter */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .search-box {
            flex: 1;
            min-width: 240px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 10px 14px 10px 36px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 13px;
            background: var(--bg-card);
            transition: border-color var(--transition);
        }
        .search-box input:focus { outline: none; border-color: var(--accent-blue); }
        .search-box::before {
            content: '\u2315';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            font-size: 16px;
        }
        .filter-select {
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 13px;
            background: var(--bg-card);
            cursor: pointer;
        }
        .result-count {
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border-light);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        .tab-badge {
            background: var(--bg-primary);
            color: var(--text-secondary);
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .tab.active .tab-badge {
            background: var(--accent-blue-light);
            color: var(--accent-blue);
        }

        /* Card Grid */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: var(--gap);
        }

        /* Workflow Card */
        .workflow-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border-top: 3px solid var(--border-light);
            transition: transform var(--transition), box-shadow var(--transition);
            overflow: hidden;
        }
        .workflow-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .workflow-card.state-active { border-top-color: var(--accent-amber); }
        .workflow-card.state-queued { border-top-color: var(--accent-blue); }
        .workflow-card.state-success { border-top-color: var(--accent-green); }
        .workflow-card.state-failed { border-top-color: var(--accent-red); }

        .card-body { padding: 16px 18px; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .card-app-name {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.2px;
        }
        .card-meta {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .status-badge.active { background: var(--accent-amber-light); color: #92400e; }
        .status-badge.queued { background: var(--accent-blue-light); color: #1e40af; }
        .status-badge.success { background: var(--accent-green-light); color: #166534; }
        .status-badge.failed { background: var(--accent-red-light); color: #991b1b; }

        /* Progress bar */
        .progress-section { margin-bottom: 12px; }
        .progress-bar-container {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .progress-bar-fill.good { background: var(--accent-green); }
        .progress-bar-fill.warning { background: var(--accent-amber); }
        .progress-bar-fill.bad { background: var(--accent-red); }

        .progress-text {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* Card stats */
        .card-stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .card-stats span { display: flex; align-items: center; gap: 4px; }
        .card-stats .label { color: var(--text-dim); }

        .card-timestamp {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 12px;
        }

        /* Card actions */
        .card-actions {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }
        .btn-card {
            padding: 6px 14px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid var(--border-light);
            background: var(--bg-card);
            color: var(--text-secondary);
            transition: all var(--transition);
        }
        .btn-card:hover { background: var(--bg-primary); color: var(--text-primary); }
        .btn-card.btn-detail {
            background: var(--accent-blue);
            color: #fff;
            border-color: var(--accent-blue);
        }
        .btn-card.btn-detail:hover { background: #2563eb; }
        .btn-card.btn-rerun {
            border-color: var(--accent-amber);
            color: var(--accent-amber);
        }
        .btn-card.btn-rerun:hover { background: var(--accent-amber-light); }

        .pr-link {
            margin-left: auto;
            font-size: 12px;
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
        }
        .pr-link:hover { text-decoration: underline; }

        /* Run history toggle */
        .run-history-toggle {
            font-size: 11px;
            color: var(--accent-blue);
            cursor: pointer;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .run-history {
            display: none;
            margin-bottom: 10px;
        }
        .run-history.show { display: block; }
        .run-history-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .run-history-item:hover { color: var(--accent-blue); }
        .run-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
        }
        .run-dot.success { background: var(--accent-green); }
        .run-dot.failed { background: var(--accent-red); }
        .run-dot.active { background: var(--accent-amber); }

        /* Compact App Card (All Apps tab) */
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 10px;
        }
        .compact-card {
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition);
            cursor: pointer;
        }
        .compact-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        .compact-app-name { font-size: 13px; font-weight: 600; }
        .compact-tool-count { font-size: 11px; color: var(--text-dim); }
        .compact-status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--border-light);
        }
        .compact-status-dot.has-run { background: var(--accent-green); }
        .compact-status-dot.running { background: var(--accent-amber); }
        .compact-status-dot.failed { background: var(--accent-red); }
        .btn-compact-run {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            background: var(--accent-blue);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-compact-run:hover { background: #2563eb; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 480px;
            max-width: 90vw;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border-light);
            font-size: 16px;
            font-weight: 700;
        }
        .modal-body { padding: 20px 24px; }
        .modal-field { margin-bottom: 14px; }
        .modal-field label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .modal-field input,
        .modal-field select,
        .modal-field textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-family: inherit;
        }
        .modal-field input:focus,
        .modal-field select:focus,
        .modal-field textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .modal-field textarea { resize: vertical; min-height: 60px; }
        .modal-field .hint {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 3px;
        }
        .modal-field-checkbox {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 14px;
        }
        .modal-field-checkbox label { margin: 0; font-size: 13px; color: var(--text-primary); }
        .modal-footer {
            padding: 14px 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn-cancel {
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
            padding: 12px 0;
        }
        .page-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-light);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition);
        }
        .page-btn:hover { background: var(--bg-primary); }
        .page-btn.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-info { font-size: 12px; color: var(--text-dim); }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            background: var(--bg-header);
            color: var(--text-on-dark);
            padding: 12px 18px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            box-shadow: var(--shadow-lg);
            animation: toastIn 0.3s ease;
        }
        .toast.success { border-left: 3px solid var(--accent-green); }
        .toast.error { border-left: 3px solid var(--accent-red); }
        .toast.info { border-left: 3px solid var(--accent-blue); }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
        .empty-state h3 { font-size: 16px; margin-bottom: 6px; color: var(--text-secondary); }
        .empty-state p { font-size: 13px; }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .card-grid { grid-template-columns: 1fr; }
            .compact-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
            .header { flex-direction: column; gap: 8px; }
        }

        /* App search dropdown */
        .app-search-container { position: relative; }
        .app-dropdown {
            position: absolute;
            top: 100%;
            left: 0; right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            display: none;
        }
        .app-dropdown.show { display: block; }
        .app-dropdown-item {
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: background var(--transition);
        }
        .app-dropdown-item:hover { background: var(--bg-primary); }
        .app-dropdown-item .app-slug { color: var(--text-dim); font-size: 11px; }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header class="header">
    <div class="header-left">
        <div class="live-dot"></div>
        <div>
            <div class="header-title">Create App Command Center</div>
            <div class="header-subtitle">Workflow orchestration for Composio integrations</div>
        </div>
    </div>
    <div class="header-right">
        <select class="env-toggle" id="envToggle">
            <option value="production">Production</option>
            <option value="staging">Staging</option>
        </select>
        <span class="last-updated" id="lastUpdated">Connecting...</span>
    </div>
</header>

<div class="container">
    <!-- Stats Row -->
    <section class="stats-row">
        <div class="stat-card running">
            <div class="stat-label">Running</div>
            <div class="stat-value" id="statRunning">0</div>
        </div>
        <div class="stat-card queued">
            <div class="stat-label">Queued</div>
            <div class="stat-value" id="statQueued">0</div>
        </div>
        <div class="stat-card completed">
            <div class="stat-label">Completed</div>
            <div class="stat-value" id="statCompleted">0</div>
        </div>
        <div class="stat-card failed">
            <div class="stat-label">Failed</div>
            <div class="stat-value" id="statFailed">0</div>
        </div>
    </section>

    <!-- Action Bar -->
    <div class="action-bar">
        <div class="action-bar-left">
            <button class="btn-primary" onclick="openTriggerModal()">+ Run New Workflow</button>
            <div class="concurrency-control">
                <span>Max concurrent:</span>
                <input type="number" id="maxConcurrent" value="8" min="1" max="20" onchange="updateMaxConcurrent(this.value)">
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search apps or workflow IDs..." oninput="applyFilters()">
        </div>
        <select class="filter-select" id="statusFilter" onchange="applyFilters()">
            <option value="all">All Statuses</option>
            <option value="active">Running</option>
            <option value="queued">Queued</option>
            <option value="success">Completed</option>
            <option value="failed">Failed</option>
        </select>
        <select class="filter-select" id="sortSelect" onchange="applyFilters()">
            <option value="recent">Most Recent</option>
            <option value="name">App Name</option>
            <option value="pass-rate">Pass Rate</option>
        </select>
        <span class="result-count" id="resultCount"></span>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="all-apps" onclick="switchTab('all-apps')">
            All Apps <span class="tab-badge" id="tabAllCount">0</span>
        </div>
        <div class="tab" data-tab="running" onclick="switchTab('running')">
            Running <span class="tab-badge" id="tabRunningCount">0</span>
        </div>
        <div class="tab" data-tab="queued" onclick="switchTab('queued')">
            Queued <span class="tab-badge" id="tabQueuedCount">0</span>
        </div>
        <div class="tab" data-tab="completed" onclick="switchTab('completed')">
            Completed <span class="tab-badge" id="tabCompletedCount">0</span>
        </div>
        <div class="tab" data-tab="failed" onclick="switchTab('failed')">
            Failed <span class="tab-badge" id="tabFailedCount">0</span>
        </div>
    </div>

    <!-- Content -->
    <div id="cardContainer"></div>
    <div class="pagination" id="pagination"></div>
</div>

<!-- Trigger Modal -->
<div class="modal-overlay" id="triggerModal">
    <div class="modal">
        <div class="modal-header">Run Create App Workflow</div>
        <div class="modal-body">
            <div class="modal-field">
                <label>App Name *</label>
                <div class="app-search-container">
                    <input type="text" id="modalAppName" placeholder="Type to search apps..." autocomplete="off"
                           oninput="filterAppDropdown(this.value)" onfocus="filterAppDropdown(this.value)">
                    <div class="app-dropdown" id="appDropdown"></div>
                </div>
            </div>
            <div class="modal-field">
                <label>Connection ID</label>
                <input type="text" id="modalConnectionId" placeholder="Optional — auto-detected if empty">
                <div class="hint">Leave blank to use the most recent active connection for this app.</div>
            </div>
            <div class="modal-field">
                <label>Environment</label>
                <select id="modalEnv">
                    <option value="production">Production</option>
                    <option value="staging">Staging</option>
                </select>
            </div>
            <div class="modal-field">
                <label>Finder Instructions</label>
                <textarea id="modalFinderInstructions" placeholder="Optional hints for endpoint discovery..."></textarea>
            </div>
            <div class="modal-field-checkbox">
                <input type="checkbox" id="modalTestAll">
                <label for="modalTestAll">Test all actions (not just newly built)</label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeTriggerModal()">Cancel</button>
            <button class="btn-primary" id="modalSubmitBtn" onclick="submitTrigger()">Run Workflow</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// --- State ---
let supabaseUrl = '';
let supabaseKey = '';
let allApps = [];      // From toolkit_coverage
let workflows = [];    // From ca_workflows
let runs = [];         // From ca_workflow_runs
let queuedItems = [];  // From ca_queued_workflows
let currentTab = 'all-apps';
let currentPage = 1;
const PAGE_SIZE = 60;
let pollInterval = null;

// --- Init ---
async function init() {
    try {
        const configResp = await fetch('/api/config');
        const config = await configResp.json();
        supabaseUrl = config.supabaseUrl;
        supabaseKey = config.supabaseAnonKey;
        await Promise.all([fetchApps(), fetchDashboardData()]);
        pollInterval = setInterval(fetchDashboardData, 10000);
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.app-search-container')) {
                document.getElementById('appDropdown').classList.remove('show');
            }
        });
        document.getElementById('searchInput').addEventListener('keydown', (e) => {
            if (e.key === 'Escape') e.target.value = '';
        });
    } catch (err) {
        console.error('Init error:', err);
        showToast('Failed to initialize dashboard', 'error');
    }
}

// --- Supabase queries ---
async function sbQuery(table, params = '') {
    const url = `${supabaseUrl}/rest/v1/${table}?select=*${params ? '&' + params : ''}`;
    const resp = await fetch(url, {
        headers: { 'apikey': supabaseKey, 'Authorization': `Bearer ${supabaseKey}` }
    });
    return resp.json();
}

async function fetchApps() {
    try {
        const data = await sbQuery('toolkit_coverage', 'select=slug,name,tool_count&order=slug.asc&limit=1000');
        allApps = data || [];
        document.getElementById('tabAllCount').textContent = allApps.length;
    } catch (err) {
        console.error('Error fetching apps:', err);
    }
}

async function fetchDashboardData() {
    try {
        const [wf, wr, q, cfg] = await Promise.all([
            sbQuery('ca_workflows'),
            sbQuery('ca_workflow_runs', 'order=started_at.desc'),
            sbQuery('ca_queued_workflows', 'order=position.asc'),
            sbQuery('ca_config', 'key=eq.max_concurrent')
        ]);
        workflows = wf || [];
        runs = wr || [];
        queuedItems = q || [];

        if (cfg && cfg.length > 0) {
            document.getElementById('maxConcurrent').value = cfg[0].value;
        }

        updateStats();
        renderCurrentView();
        document.getElementById('lastUpdated').textContent =
            'Updated ' + new Date().toLocaleTimeString();
    } catch (err) {
        console.error('Error fetching data:', err);
    }
}

// --- Stats ---
function updateStats() {
    const activeRuns = runs.filter(r => r.status === 'active');
    const completedRuns = runs.filter(r => r.status === 'completed' && isSuccess(r.execution_state));
    const failedRuns = runs.filter(r => r.status === 'completed' && isFailed(r.execution_state));

    document.getElementById('statRunning').textContent = activeRuns.length;
    document.getElementById('statQueued').textContent = queuedItems.length;
    document.getElementById('statCompleted').textContent = completedRuns.length;
    document.getElementById('statFailed').textContent = failedRuns.length;

    document.getElementById('tabRunningCount').textContent = activeRuns.length;
    document.getElementById('tabQueuedCount').textContent = queuedItems.length;
    document.getElementById('tabCompletedCount').textContent = completedRuns.length;
    document.getElementById('tabFailedCount').textContent = failedRuns.length;
}

function isSuccess(state) {
    return ['SUCCESS', 'SUCCESS_NOT_TESTABLE'].includes((state || '').toUpperCase());
}

function isFailed(state) {
    return ['FAILED', 'FAILED_AUTH_ISSUE', 'INFRA_EXECUTION_FAILED', 'INFRA_INITIATION_FAILED', 'TIMED_OUT', 'ABORTED'].includes((state || '').toUpperCase());
}

// --- Tabs ---
function switchTab(tab) {
    currentTab = tab;
    currentPage = 1;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
    renderCurrentView();
}

// --- Rendering ---
function renderCurrentView() {
    applyFilters();
}

function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const sort = document.getElementById('sortSelect').value;
    const container = document.getElementById('cardContainer');

    if (currentTab === 'all-apps') {
        renderAllApps(search);
        return;
    }

    // Get workflows for this tab
    let filteredRuns = getLatestRunsPerWorkflow();

    // Tab filter
    if (currentTab === 'running') filteredRuns = filteredRuns.filter(r => r.status === 'active');
    else if (currentTab === 'queued') { renderQueuedCards(search); return; }
    else if (currentTab === 'completed') filteredRuns = filteredRuns.filter(r => r.status === 'completed' && isSuccess(r.execution_state));
    else if (currentTab === 'failed') filteredRuns = filteredRuns.filter(r => r.status === 'completed' && isFailed(r.execution_state));

    // Status filter
    if (statusFilter !== 'all') {
        if (statusFilter === 'active') filteredRuns = filteredRuns.filter(r => r.status === 'active');
        else if (statusFilter === 'success') filteredRuns = filteredRuns.filter(r => isSuccess(r.execution_state));
        else if (statusFilter === 'failed') filteredRuns = filteredRuns.filter(r => isFailed(r.execution_state));
    }

    // Search
    if (search) {
        filteredRuns = filteredRuns.filter(r => {
            const wf = workflows.find(w => w.workflow_id === r.workflow_id);
            const appName = wf ? wf.app_name : '';
            return appName.toLowerCase().includes(search) ||
                   r.workflow_id.toLowerCase().includes(search);
        });
    }

    // Sort
    if (sort === 'name') {
        filteredRuns.sort((a, b) => {
            const aName = (workflows.find(w => w.workflow_id === a.workflow_id) || {}).app_name || '';
            const bName = (workflows.find(w => w.workflow_id === b.workflow_id) || {}).app_name || '';
            return aName.localeCompare(bName);
        });
    } else if (sort === 'pass-rate') {
        filteredRuns.sort((a, b) => {
            const aRate = a.total > 0 ? a.passed / a.total : 0;
            const bRate = b.total > 0 ? b.passed / b.total : 0;
            return bRate - aRate;
        });
    } else {
        filteredRuns.sort((a, b) => new Date(b.started_at) - new Date(a.started_at));
    }

    // Paginate
    const totalPages = Math.ceil(filteredRuns.length / PAGE_SIZE);
    const paged = filteredRuns.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);

    document.getElementById('resultCount').textContent = `${filteredRuns.length} workflows`;

    container.innerHTML = paged.length > 0
        ? '<div class="card-grid">' + paged.map(r => renderWorkflowCard(r)).join('') + '</div>'
        : '<div class="empty-state"><h3>No workflows found</h3><p>Try adjusting your filters or run a new workflow.</p></div>';

    renderPagination(totalPages);
}

function getLatestRunsPerWorkflow() {
    const latest = {};
    for (const r of runs) {
        if (!latest[r.workflow_id] || r.run_number > latest[r.workflow_id].run_number) {
            latest[r.workflow_id] = r;
        }
    }
    return Object.values(latest);
}

function getRunsForWorkflow(workflowId) {
    return runs.filter(r => r.workflow_id === workflowId).sort((a, b) => b.run_number - a.run_number);
}

function renderWorkflowCard(run) {
    const wf = workflows.find(w => w.workflow_id === run.workflow_id) || {};
    const appName = wf.app_name || 'Unknown';
    const isActive = run.status === 'active';
    const success = isSuccess(run.execution_state);
    const failed = isFailed(run.execution_state);
    const stateClass = isActive ? 'state-active' : success ? 'state-success' : failed ? 'state-failed' : '';
    const badgeClass = isActive ? 'active' : success ? 'success' : failed ? 'failed' : 'queued';
    const badgeText = isActive ? 'Running' : (run.execution_state || 'PENDING').replace(/_/g, ' ');
    const passRate = run.total > 0 ? (run.passed / run.total * 100) : 0;
    const barClass = passRate >= 70 ? 'good' : passRate >= 40 ? 'warning' : 'bad';
    const allRuns = getRunsForWorkflow(run.workflow_id);
    const hasMultipleRuns = allRuns.length > 1;

    const prLink = run.pr_url
        ? `<a class="pr-link" href="${run.pr_url}" target="_blank">PR #${run.pr_number}</a>`
        : run.pr_number
            ? `<a class="pr-link" href="https://github.com/ComposioHQ/mercury/pull/${run.pr_number}" target="_blank">PR #${run.pr_number}</a>`
            : '';

    const startedStr = run.started_at
        ? new Date(run.started_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
        : '';

    let runHistoryHtml = '';
    if (hasMultipleRuns) {
        const historyItems = allRuns.slice(0, 5).map(r => {
            const dotClass = r.status === 'active' ? 'active' : isSuccess(r.execution_state) ? 'success' : 'failed';
            return `<div class="run-history-item" onclick="window.location.href='/detail?workflow_id=${r.workflow_id}&run=${r.run_number}'">
                <span class="run-dot ${dotClass}"></span>
                Run #${r.run_number} — ${r.passed}/${r.total} passed
            </div>`;
        }).join('');
        runHistoryHtml = `
            <div class="run-history-toggle" onclick="this.nextElementSibling.classList.toggle('show')">
                ${allRuns.length} runs ▾
            </div>
            <div class="run-history">${historyItems}</div>`;
    }

    return `
    <div class="workflow-card ${stateClass}">
        <div class="card-body">
            <div class="card-header">
                <div>
                    <div class="card-app-name">${escHtml(appName)}</div>
                    <div class="card-meta">Run #${run.run_number} · ${run.workflow_id}</div>
                </div>
                <span class="status-badge ${badgeClass}">${badgeText}</span>
            </div>

            ${run.total > 0 ? `
            <div class="progress-section">
                <div class="progress-bar-container">
                    <div class="progress-bar-fill ${barClass}" style="width: ${passRate}%"></div>
                </div>
                <div class="progress-text">
                    <span>${run.passed}/${run.total} passed</span>
                    <span>${Math.round(passRate)}%</span>
                </div>
            </div>` : ''}

            <div class="card-stats">
                ${run.endpoints_discovered ? `<span><span class="label">Endpoints:</span> ${run.endpoints_discovered}</span>` : ''}
                ${run.actions_built ? `<span><span class="label">Built:</span> ${run.actions_built}</span>` : ''}
                ${prLink ? `<span>${prLink}</span>` : ''}
            </div>

            <div class="card-timestamp">${startedStr}</div>

            ${runHistoryHtml}

            <div class="card-actions">
                ${!isActive ? `<button class="btn-card btn-rerun" onclick="openRerunModal('${run.workflow_id}', '${escHtml(appName)}', '${wf.connection_id || ''}')">Rerun</button>` : ''}
                <button class="btn-card btn-detail" onclick="window.location.href='/detail?workflow_id=${run.workflow_id}&run=${run.run_number}'">View Details</button>
            </div>
        </div>
    </div>`;
}

function renderAllApps(search) {
    const container = document.getElementById('cardContainer');
    let filtered = allApps;

    if (search) {
        filtered = filtered.filter(a =>
            a.slug.toLowerCase().includes(search) ||
            (a.name || '').toLowerCase().includes(search)
        );
    }

    const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
    const paged = filtered.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);

    document.getElementById('resultCount').textContent = `${filtered.length} apps`;

    if (paged.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No apps found</h3><p>Try a different search term.</p></div>';
        renderPagination(0);
        return;
    }

    const cards = paged.map(app => {
        const wf = workflows.find(w => w.app_name === app.slug);
        let statusDot = '';
        if (wf) {
            const latestRun = runs
                .filter(r => r.workflow_id === wf.workflow_id)
                .sort((a, b) => b.run_number - a.run_number)[0];
            if (latestRun) {
                if (latestRun.status === 'active') statusDot = 'running';
                else if (isSuccess(latestRun.execution_state)) statusDot = 'has-run';
                else if (isFailed(latestRun.execution_state)) statusDot = 'failed';
            }
        }

        return `<div class="compact-card" onclick="openTriggerModal('${escHtml(app.slug)}')">
            <div>
                <div class="compact-app-name">${escHtml(app.name || app.slug)}</div>
                <div class="compact-tool-count">${app.tool_count || 0} tools</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
                <span class="compact-status-dot ${statusDot}"></span>
                <button class="btn-compact-run" onclick="event.stopPropagation();openTriggerModal('${escHtml(app.slug)}')">Run</button>
            </div>
        </div>`;
    }).join('');

    container.innerHTML = '<div class="compact-grid">' + cards + '</div>';
    renderPagination(totalPages);
}

function renderQueuedCards(search) {
    const container = document.getElementById('cardContainer');
    let filtered = queuedItems;

    if (search) {
        filtered = filtered.filter(q => q.app_name.toLowerCase().includes(search));
    }

    document.getElementById('resultCount').textContent = `${filtered.length} queued`;

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>Queue is empty</h3><p>No workflows waiting to run.</p></div>';
        document.getElementById('pagination').innerHTML = '';
        return;
    }

    const cards = filtered.map((q, i) => `
        <div class="workflow-card state-queued">
            <div class="card-body">
                <div class="card-header">
                    <div>
                        <div class="card-app-name">${escHtml(q.app_name)}</div>
                        <div class="card-meta">Position #${q.position || i + 1}</div>
                    </div>
                    <span class="status-badge queued">Queued</span>
                </div>
                <div class="card-timestamp">Queued ${new Date(q.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
            </div>
        </div>
    `).join('');

    container.innerHTML = '<div class="card-grid">' + cards + '</div>';
    document.getElementById('pagination').innerHTML = '';
}

// --- Pagination ---
function renderPagination(totalPages) {
    const el = document.getElementById('pagination');
    if (totalPages <= 1) { el.innerHTML = ''; return; }

    let html = `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;

    const start = Math.max(1, currentPage - 2);
    const end = Math.min(totalPages, currentPage + 2);

    if (start > 1) html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
    if (start > 2) html += `<span class="page-info">...</span>`;

    for (let i = start; i <= end; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }

    if (end < totalPages - 1) html += `<span class="page-info">...</span>`;
    if (end < totalPages) html += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;

    html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;

    el.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    renderCurrentView();
    window.scrollTo({ top: 300, behavior: 'smooth' });
}

// --- Modal ---
function openTriggerModal(prefillApp) {
    const modal = document.getElementById('triggerModal');
    modal.classList.add('show');
    const input = document.getElementById('modalAppName');
    if (prefillApp) {
        input.value = prefillApp;
    } else {
        input.value = '';
    }
    document.getElementById('modalConnectionId').value = '';
    document.getElementById('modalFinderInstructions').value = '';
    document.getElementById('modalTestAll').checked = false;
    document.getElementById('modalEnv').value = document.getElementById('envToggle').value;
}

function closeTriggerModal() {
    document.getElementById('triggerModal').classList.remove('show');
}

function openRerunModal(workflowId, appName, connectionId) {
    openTriggerModal(appName);
    document.getElementById('modalConnectionId').value = connectionId || '';
    // Store workflow_id for rerun
    document.getElementById('modalSubmitBtn').dataset.rerunWorkflowId = workflowId;
}

async function submitTrigger() {
    const btn = document.getElementById('modalSubmitBtn');
    const appName = document.getElementById('modalAppName').value.trim();
    const connectionId = document.getElementById('modalConnectionId').value.trim();
    const env = document.getElementById('modalEnv').value;
    const finderInstructions = document.getElementById('modalFinderInstructions').value.trim();
    const testAll = document.getElementById('modalTestAll').checked;
    const rerunWorkflowId = btn.dataset.rerunWorkflowId;

    if (!appName) {
        showToast('App name is required', 'error');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Running...';

    try {
        const endpoint = rerunWorkflowId ? '/api/retry' : '/api/trigger';
        const body = rerunWorkflowId
            ? { app_name: appName, workflow_id: rerunWorkflowId, connection_id: connectionId || undefined, environment: env }
            : { app_name: appName, connection_id: connectionId || undefined, environment: env, finder_instructions: finderInstructions || undefined, test_all_actions: testAll || undefined };

        const resp = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const result = await resp.json();

        if (result.success) {
            showToast(`Workflow started for ${appName} (${result.workflow_id} #${result.run_number})`, 'success');
        } else if (result.queued) {
            showToast(`${appName} queued at position ${result.position}`, 'info');
        } else if (result.error === 'already_running') {
            showToast(`${appName} is already running`, 'error');
        } else {
            showToast(result.error || result.details || 'Failed to trigger workflow', 'error');
        }

        closeTriggerModal();
        btn.dataset.rerunWorkflowId = '';
        await fetchDashboardData();
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Workflow';
    }
}

// --- App dropdown ---
function filterAppDropdown(query) {
    const dropdown = document.getElementById('appDropdown');
    if (!query || query.length < 1) {
        dropdown.classList.remove('show');
        return;
    }

    const q = query.toLowerCase();
    const matches = allApps.filter(a =>
        a.slug.toLowerCase().includes(q) || (a.name || '').toLowerCase().includes(q)
    ).slice(0, 15);

    if (matches.length === 0) {
        dropdown.classList.remove('show');
        return;
    }

    dropdown.innerHTML = matches.map(a => `
        <div class="app-dropdown-item" onclick="selectApp('${escHtml(a.slug)}')">
            ${escHtml(a.name || a.slug)} <span class="app-slug">${escHtml(a.slug)}</span>
        </div>
    `).join('');
    dropdown.classList.add('show');
}

function selectApp(slug) {
    document.getElementById('modalAppName').value = slug;
    document.getElementById('appDropdown').classList.remove('show');
}

// --- Config ---
async function updateMaxConcurrent(value) {
    try {
        const v = parseInt(value);
        if (v < 1 || v > 20) return;
        await fetch(`${supabaseUrl}/rest/v1/ca_config?key=eq.max_concurrent`, {
            method: 'PATCH',
            headers: {
                'apikey': supabaseKey,
                'Authorization': `Bearer ${supabaseKey}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify({ value: v })
        });
        showToast(`Max concurrent set to ${v}`, 'info');
    } catch (err) {
        console.error('Config update error:', err);
    }
}

// --- Toast ---
function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// --- Utility ---
function escHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// --- Keyboard shortcut ---
document.addEventListener('keydown', (e) => {
    if (e.key === '/' && !e.target.closest('input, textarea, select')) {
        e.preventDefault();
        document.getElementById('searchInput').focus();
    }
});

// --- Start ---
init();
</script>
</body>
</html>
