<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Detail</title>
    <style>
        :root {
            --bg-primary: #0b1120;
            --bg-secondary: #111827;
            --bg-card: #1e293b;
            --bg-card-hover: #263548;
            --bg-header: #0b1120;
            --bg-input: #1e293b;
            --bg-elevated: #334155;
            --border-light: #334155;
            --border-medium: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-dim: #64748b;
            --text-on-dark: #f8fafc;
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --accent-blue-muted: rgba(59,130,246,0.15);
            --accent-green: #22c55e;
            --accent-green-muted: rgba(34,197,94,0.15);
            --accent-amber: #f59e0b;
            --accent-amber-muted: rgba(245,158,11,0.15);
            --accent-red: #ef4444;
            --accent-red-muted: rgba(239,68,68,0.15);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --radius: 12px;
            --radius-sm: 8px;
            --gap: 16px;
            --transition: 0.2s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .header {
            background: var(--bg-header);
            border-bottom: 1px solid var(--border-light);
            color: var(--text-on-dark);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .back-link {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 13px;
            transition: color var(--transition);
        }
        .back-link:hover { color: var(--text-on-dark); }
        .header-title { font-size: 18px; font-weight: 700; }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

        /* Detail header */
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .detail-app-name { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; color: var(--text-primary); }
        .detail-meta { font-size: 13px; color: var(--text-dim); margin-top: 4px; }
        .detail-meta code {
            background: var(--bg-elevated);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-badge {
            padding: 5px 14px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-badge.active { background: var(--accent-amber-muted); color: var(--accent-amber); }
        .status-badge.success { background: var(--accent-green-muted); color: var(--accent-green); }
        .status-badge.failed { background: var(--accent-red-muted); color: var(--accent-red); }
        .status-badge.pending { background: var(--accent-blue-muted); color: var(--accent-blue); }

        /* Run selector */
        .run-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .run-tab {
            padding: 6px 14px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            background: var(--bg-card);
            color: var(--text-secondary);
            transition: all var(--transition);
        }
        .run-tab:hover { border-color: var(--accent-blue); color: var(--text-primary); }
        .run-tab.active {
            background: var(--accent-blue);
            color: #fff;
            border-color: var(--accent-blue);
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--gap);
            margin-bottom: 24px;
        }
        .detail-stat {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 16px 20px;
            box-shadow: var(--shadow-sm);
        }
        .detail-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .detail-stat-value { font-size: 24px; font-weight: 800; color: var(--text-primary); }

        /* Pipeline visual */
        .pipeline {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 20px 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
        }
        .pipeline h3 { font-size: 14px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        .pipeline-stages {
            display: flex;
            gap: 0;
            align-items: center;
            overflow-x: auto;
        }
        .pipeline-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 100px;
        }
        .pipeline-dot {
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
        }
        .pipeline-dot.done { background: var(--accent-green); }
        .pipeline-dot.active { background: var(--accent-amber); animation: pulse 2s infinite; }
        .pipeline-dot.pending { background: var(--border-medium); }
        .pipeline-dot.failed { background: var(--accent-red); }
        .pipeline-label { font-size: 11px; color: var(--text-secondary); text-align: center; }
        .pipeline-arrow {
            width: 40px;
            height: 2px;
            background: var(--border-light);
            flex-shrink: 0;
        }

        /* Sections */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 20px 24px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
        }
        .section h3 { font-size: 14px; font-weight: 700; margin-bottom: 14px; color: var(--text-primary); }

        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table thead th {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 2px solid var(--border-light);
            color: var(--text-dim);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-table tbody td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
        }
        .data-table tbody tr:hover { background: var(--bg-secondary); }
        .test-pass { color: var(--accent-green); font-weight: 600; }
        .test-fail { color: var(--accent-red); font-weight: 600; }

        /* Failure analysis */
        .failure-box {
            background: var(--accent-red-muted);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: var(--radius-sm);
            padding: 14px 18px;
            font-size: 13px;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            color: var(--text-primary);
        }

        /* Run log */
        .log-timeline { list-style: none; }
        .log-entry {
            padding: 6px 0 6px 20px;
            position: relative;
            font-size: 12px;
            border-left: 2px solid var(--border-light);
        }
        .log-entry::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 12px;
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--border-medium);
        }
        .log-entry.info::before { background: var(--accent-blue); }
        .log-entry.warning::before { background: var(--accent-amber); }
        .log-entry.error::before { background: var(--accent-red); }
        .log-time { color: var(--text-dim); font-size: 11px; margin-right: 8px; }
        .log-message { color: var(--text-primary); }
        .log-details {
            margin-top: 4px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            color: var(--text-secondary);
        }
        .log-details.show { display: block; }
        .log-toggle {
            color: var(--accent-blue);
            cursor: pointer;
            font-size: 11px;
            margin-left: 8px;
        }
        .log-toggle:hover { text-decoration: underline; }

        /* PR section */
        .pr-box {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 18px;
            background: var(--accent-blue-muted);
            border-radius: var(--radius-sm);
        }
        .pr-box a {
            color: var(--accent-blue);
            font-weight: 600;
            text-decoration: none;
        }
        .pr-box a:hover { text-decoration: underline; }
        .pr-state-badge {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .btn-primary {
            background: var(--accent-blue);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition);
        }
        .btn-primary:hover { background: var(--accent-blue-hover); }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
            font-size: 14px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @media (max-width: 768px) {
            .detail-header { flex-direction: column; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-left">
        <a href="/" class="back-link">&larr; Dashboard</a>
        <div class="header-title" id="headerTitle">Workflow Detail</div>
    </div>
</header>

<div class="container">
    <div id="content">
        <div class="loading">Loading workflow details...</div>
    </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const workflowId = params.get('workflow_id');
let currentRunNumber = parseInt(params.get('run') || '1', 10);
if (isNaN(currentRunNumber) || currentRunNumber < 1) currentRunNumber = 1;
let detailData = null;
let allRunNumbers = [];

async function init() {
    if (!workflowId) {
        document.getElementById('content').innerHTML = '<div class="loading">No workflow_id provided.</div>';
        return;
    }

    // First get all runs for this workflow from Supabase
    try {
        const configResp = await fetch('/api/config.js');
        const config = await configResp.json();
        const sbUrl = config.supabaseUrl;
        const sbKey = config.supabaseAnonKey;

        const runsResp = await fetch(
            `${sbUrl}/rest/v1/ca_workflow_runs?workflow_id=eq.${encodeURIComponent(workflowId)}&select=run_number,status,execution_state,failure_summary&order=run_number.asc`,
            { headers: { 'apikey': sbKey, 'Authorization': `Bearer ${sbKey}` } }
        );
        const runData = await runsResp.json();
        allRunNumbers = Array.isArray(runData) ? runData : [];
    } catch (e) {
        console.error('Error fetching runs:', e);
        allRunNumbers = [];
    }

    await loadRunDetail(currentRunNumber);
}

async function loadRunDetail(runNumber) {
    currentRunNumber = runNumber;
    try {
        const resp = await fetch('/api/get-detail.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ workflow_id: workflowId, run_number: runNumber })
        });
        detailData = await resp.json();

        // If API didn't find it (trigger failures aren't in Integrator API), build from Supabase data
        if (!detailData || !detailData.workflow_id) {
            const sbRun = allRunNumbers.find(r => r.run_number === runNumber);
            if (sbRun && sbRun.execution_state === 'TRIGGER_FAILED') {
                // Fetch full run + workflow data from Supabase
                const configResp = await fetch('/api/config.js');
                const config = await configResp.json();
                const [wfResp, runResp] = await Promise.all([
                    fetch(`${config.supabaseUrl}/rest/v1/ca_workflows?workflow_id=eq.${encodeURIComponent(workflowId)}&limit=1`,
                        { headers: { 'apikey': config.supabaseAnonKey, 'Authorization': `Bearer ${config.supabaseAnonKey}` } }),
                    fetch(`${config.supabaseUrl}/rest/v1/ca_workflow_runs?workflow_id=eq.${encodeURIComponent(workflowId)}&run_number=eq.${runNumber}&limit=1`,
                        { headers: { 'apikey': config.supabaseAnonKey, 'Authorization': `Bearer ${config.supabaseAnonKey}` } })
                ]);
                const [wfData, runData] = await Promise.all([wfResp.json(), runResp.json()]);
                const wf = Array.isArray(wfData) && wfData[0] ? wfData[0] : {};
                const run = Array.isArray(runData) && runData[0] ? runData[0] : {};
                detailData = {
                    workflow_id: workflowId,
                    toolkit_name: wf.app_name || 'Unknown',
                    run_number: runNumber,
                    execution_state: 'TRIGGER_FAILED',
                    created_at: run.started_at,
                    failure_summary: run.failure_summary || '',
                    run_log: [],
                    failed_actions: []
                };
            }
        }
        render();
    } catch (err) {
        document.getElementById('content').innerHTML =
            `<div class="loading">Error loading: ${esc(err.message)}</div>`;
    }
}

function render() {
    const d = detailData;
    if (!d || !d.workflow_id) {
        document.getElementById('content').innerHTML = '<div class="loading">Workflow not found.</div>';
        return;
    }

    const appName = d.toolkit_name || 'Unknown';
    const state = (d.execution_state || 'PENDING').toUpperCase();
    const isActive = ['STARTED', 'PENDING'].includes(state);
    const isSucc = ['SUCCESS', 'SUCCESS_NOT_TESTABLE', 'COMPLETED'].includes(state);
    const isFail = ['FAILED', 'FAILED_AUTH_ISSUE', 'INFRA_EXECUTION_FAILED', 'INFRA_INITIATION_FAILED', 'TIMED_OUT', 'ABORTED', 'TRIGGER_FAILED'].includes(state);
    const badgeClass = isActive ? 'active' : isSucc ? 'success' : isFail ? 'failed' : 'pending';

    document.getElementById('headerTitle').textContent = `${appName} — Run #${d.run_number || currentRunNumber}`;
    document.title = `${appName} — Workflow Detail`;

    // Extract test results from response_json
    let actionResults = {};
    let endpointsFound = 0;
    let newActions = [];
    let prUrl = null;

    if (d.response_json && !d.response_json._truncated && d.response_json.execution_result) {
        const er = d.response_json.execution_result;
        endpointsFound = er.finder_response?.total_found || 0;
        newActions = er.new_actions || [];
        actionResults = er.testing_result?.action_results || er.action_results || {};
        prUrl = d.response_json.pr_url;
    }

    const failedActions = d.failed_actions || [];
    const totalActions = Object.keys(actionResults).length;
    const passedActions = totalActions - failedActions.length;

    if (!prUrl && d.pr_number) {
        prUrl = `https://github.com/ComposioHQ/mercury/pull/${d.pr_number}`;
    }
    // Validate URL protocol to prevent javascript: XSS
    if (prUrl && !prUrl.startsWith('https://') && !prUrl.startsWith('http://')) {
        prUrl = null;
    }

    // Find failure summary — from detailData directly (trigger failures) or from CurlTester run_log
    let failureSummary = d.failure_summary || '';
    const runLog = d.run_log || [];
    if (!failureSummary) {
        for (const entry of runLog) {
            if ((entry.message || '').startsWith('CurlTester:') && entry.details) {
                failureSummary = entry.details;
                break;
            }
        }
    }

    // Determine pipeline stages
    const stages = getPipelineStages(state, runLog, d);

    // Build run selector
    const runSelectorHtml = allRunNumbers.length > 1
        ? `<div class="run-selector">${allRunNumbers.map(r =>
            `<div class="run-tab ${r.run_number === currentRunNumber ? 'active' : ''}"
                  onclick="loadRunDetail(${r.run_number})">
                Run #${r.run_number}
            </div>`
        ).join('')}</div>`
        : '';

    // Build test results table
    let testTableHtml = '';
    const entries = Object.entries(actionResults);
    if (entries.length > 0) {
        const rows = entries.map(([name, r]) => {
            const cls = r.success ? 'test-pass' : 'test-fail';
            const status = r.success ? 'PASSED' : 'FAILED';
            return `<tr><td style="font-weight:500;color:var(--text-primary)">${esc(name)}</td><td class="${cls}">${status}</td><td>${esc(r.response_summary || r.result_summary || '')}</td></tr>`;
        }).join('');
        testTableHtml = `
        <div class="section">
            <h3>Test Results (${passedActions}/${totalActions} passed)</h3>
            <table class="data-table">
                <thead><tr><th>Action</th><th>Status</th><th>Summary</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
        </div>`;
    } else if (failedActions.length > 0) {
        testTableHtml = `
        <div class="section">
            <h3>Failed Actions (${failedActions.length})</h3>
            <table class="data-table">
                <thead><tr><th>Action Name</th></tr></thead>
                <tbody>${failedActions.map(a => `<tr><td class="test-fail">${esc(a)}</td></tr>`).join('')}</tbody>
            </table>
        </div>`;
    }

    // Failure analysis
    let failureHtml = '';
    if (failureSummary) {
        const failureLabel = state === 'TRIGGER_FAILED' ? 'Trigger Error' : 'Failure Analysis (CurlTester)';
        failureHtml = `
        <div class="section">
            <h3>${failureLabel}</h3>
            <div class="failure-box">${esc(failureSummary)}</div>
        </div>`;
    }

    // PR section
    let prHtml = '';
    if (d.pr_number) {
        const prState = (d.pr_state || 'PR_CREATED').replace(/_/g, ' ');
        prHtml = `
        <div class="section">
            <h3>Pull Request</h3>
            <div class="pr-box">
                <a href="${esc(prUrl)}" target="_blank">PR #${d.pr_number}</a>
                <span class="pr-state-badge">${esc(prState)}</span>
            </div>
        </div>`;
    }

    // Run log
    let logHtml = '';
    if (runLog.length > 0) {
        const logEntries = runLog.map(e => {
            const level = (e.log_level || 'INFO').toLowerCase();
            const time = e.timestamp ? new Date(e.timestamp).toLocaleTimeString() : '';
            const hasDetails = e.details && e.details.length > 0;
            return `
            <li class="log-entry ${level}">
                <span class="log-time">${time}</span>
                <span class="log-message">${esc(e.message || '')}</span>
                ${hasDetails ? `<span class="log-toggle" onclick="this.nextElementSibling.classList.toggle('show')">details</span>
                <div class="log-details">${esc(e.details)}</div>` : ''}
            </li>`;
        }).join('');
        logHtml = `
        <div class="section">
            <h3>Run Log (${runLog.length} entries)</h3>
            <ul class="log-timeline">${logEntries}</ul>
        </div>`;
    }

    document.getElementById('content').innerHTML = `
        <div class="detail-header">
            <div>
                <div class="detail-app-name">${esc(appName)}</div>
                <div class="detail-meta">
                    Workflow <code>${esc(d.workflow_id)}</code> · Run #${d.run_number || currentRunNumber}
                    ${d.created_at ? ` · Started ${new Date(d.created_at).toLocaleString()}` : ''}
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
                <span class="status-badge ${badgeClass}">${esc(state.replace(/_/g, ' '))}</span>
                ${!isActive ? `<button class="btn-primary" onclick="rerun()">Rerun</button>` : ''}
                <a class="btn-primary" href="https://usefulagents.com/workflows/${encodeURIComponent(workflowId)}?run=${currentRunNumber}" target="_blank" style="text-decoration:none;background:var(--bg-card);border:1px solid var(--border-light)">Logs</a>
            </div>
        </div>

        ${runSelectorHtml}

        <div class="stats-grid">
            <div class="detail-stat">
                <div class="detail-stat-label">Endpoints Found</div>
                <div class="detail-stat-value">${endpointsFound}</div>
            </div>
            <div class="detail-stat">
                <div class="detail-stat-label">Actions Built</div>
                <div class="detail-stat-value">${newActions.length}</div>
            </div>
            <div class="detail-stat">
                <div class="detail-stat-label">Tests Passed</div>
                <div class="detail-stat-value" style="color: ${passedActions > 0 ? 'var(--accent-green)' : 'inherit'}">${totalActions > 0 ? passedActions + '/' + totalActions : '—'}</div>
            </div>
            <div class="detail-stat">
                <div class="detail-stat-label">PR Status</div>
                <div class="detail-stat-value" style="font-size:16px">${d.pr_number ? `#${d.pr_number}` : '—'}</div>
            </div>
        </div>

        <div class="pipeline">
            <h3>Pipeline Progress</h3>
            <div class="pipeline-stages">
                ${stages.map((s, i) => {
                    const arrow = i < stages.length - 1 ? '<div class="pipeline-arrow"></div>' : '';
                    return `<div class="pipeline-stage">
                        <div class="pipeline-dot ${s.status}">${s.icon}</div>
                        <div class="pipeline-label">${s.label}</div>
                    </div>${arrow}`;
                }).join('')}
            </div>
        </div>

        ${testTableHtml}
        ${failureHtml}
        ${prHtml}
        ${logHtml}
    `;
}

function getPipelineStages(state, runLog, data) {
    const messages = runLog.map(e => (e.message || '').toLowerCase());
    const hasMsg = (keyword) => messages.some(m => m.includes(keyword));

    const stages = [
        { label: 'Finder', icon: '1', status: 'pending' },
        { label: 'Curl Test', icon: '2', status: 'pending' },
        { label: 'Builder', icon: '3', status: 'pending' },
        { label: 'Test & Fix', icon: '4', status: 'pending' },
        { label: 'PR', icon: '5', status: 'pending' },
    ];

    // Mark stages based on run_log
    if (hasMsg('actionfinder')) stages[0].status = hasMsg('actionfinder') && (hasMsg('actionbuilder') || hasMsg('curltester')) ? 'done' : 'active';
    if (hasMsg('curltester')) stages[1].status = hasMsg('actionbuilder') ? 'done' : 'active';
    if (hasMsg('actionbuilder')) stages[2].status = hasMsg('testandfix') || hasMsg('test_and_fix') || hasMsg('testfix') ? 'done' : 'active';
    if (hasMsg('testandfix') || hasMsg('test_and_fix') || hasMsg('testfix') || hasMsg('actions passed')) {
        stages[3].status = data.pr_number ? 'done' : 'active';
    }
    if (data.pr_number) stages[4].status = 'done';

    // Terminal state overrides
    if (['FAILED', 'FAILED_AUTH_ISSUE', 'TIMED_OUT', 'ABORTED', 'INFRA_EXECUTION_FAILED', 'INFRA_INITIATION_FAILED', 'TRIGGER_FAILED'].includes(state)) {
        const lastActive = stages.findLastIndex(s => s.status === 'active');
        if (lastActive >= 0) stages[lastActive].status = 'failed';
    }

    // Check marks
    stages.forEach(s => {
        if (s.status === 'done') s.icon = '✓';
        else if (s.status === 'failed') s.icon = '✕';
    });

    return stages;
}

async function rerun() {
    const appName = detailData.toolkit_name;
    try {
        const resp = await fetch('/api/retry.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_name: appName, workflow_id: workflowId })
        });
        const result = await resp.json();
        if (result.success) {
            window.location.href = `/detail?workflow_id=${encodeURIComponent(result.workflow_id)}&run=${result.run_number}`;
        } else {
            alert('Rerun failed: ' + (result.error || result.details || 'Unknown error'));
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

function esc(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
}

init();
</script>
</body>
</html>
